<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Principal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .header div {
            cursor: pointer;
        }

        .chat-container {
            display: flex;
            flex: 1;
        }

        .chat-list {
            width: 20%;
            background-color: #f4f4f4;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .chat-list div {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        .chat-list div.active {
            background-color: #ddd;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages .messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .chat-messages .input-container {
            display: flex;
            align-items: center;
        }

        .chat-messages input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }

        .chat-messages button {
            padding: 10px 20px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .chat-messages button:hover {
            background-color: #4cae4c;
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            margin-top: 0;
            text-align: center;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            margin-top: -10px;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        input[type="text"], button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            background-color: #5cb85c;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #4cae4c;
        }
    </style>
</head>
<body>
    <div class="header">
        <div id="nuevoChat">Nuevo chat</div>
        <div id="agregarContacto">Agregar Contacto</div>
        <div>Chat Grupal</div>
        <div>Detalle de Contacto</div>
        <div>Mostrar todos los contactos</div>
        <div id="cerrarSesion">Cerrar sesión</div>
    </div>

    <div class="chat-container">
        <div class="chat-list" id="chatList">
            <!-- Lista de chats -->
        </div>
        <div class="chat-messages">
            <div class="messages" id="messageContainer">
                <!-- Mensajes se mostrarán aquí -->
            </div>
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Escribe tu mensaje aquí...">
                <button id="sendMessageButton">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Chat -->
    <div id="nuevoChatModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Ingresa usuario</h2>
            <input type="text" id="nuevoChatUsuario" placeholder="Usuario...">
            <button id="iniciarChat">Iniciar</button>
        </div>
    </div>

    <!-- Modal para Agregar Contacto -->
    <div id="agregarContactoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Agregar Contacto</h2>
            <input type="text" id="contactJid" placeholder="JID del contacto...">
            <button id="agregarContactoButton">Agregar</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io();

        let currentChatUser = null;
        let chats = {}; // Almacenará los mensajes de cada chat

        // Mostrar el modal para nuevo chat
        document.getElementById('nuevoChat').onclick = function() {
            document.getElementById('nuevoChatModal').style.display = "block";
        };

        // Mostrar el modal para agregar contacto
        document.getElementById('agregarContacto').onclick = function() {
            document.getElementById('agregarContactoModal').style.display = "block";
        };

        // Cerrar los modales
        document.querySelectorAll('.close').forEach(closeButton => {
            closeButton.onclick = function() {
                document.querySelectorAll('.modal').forEach(modal => modal.style.display = "none");
            };
        });

        // Iniciar chat
        document.getElementById('iniciarChat').onclick = async function() {
            const usuario = document.getElementById('nuevoChatUsuario').value;
            if (usuario) {
                await iniciarChat(usuario);
            }
        };

        // Función para iniciar chat
        async function iniciarChat(usuario) {
            if (!chats[usuario]) {
                chats[usuario] = [];
            }

            currentChatUser = usuario;

            // Agregar el nuevo chat al contenedor de la izquierda si no existe
            if (!document.getElementById('chat_' + usuario)) {
                const chatList = document.getElementById('chatList');
                const newChat = document.createElement('div');
                newChat.textContent = usuario;
                newChat.id = 'chat_' + usuario;
                newChat.classList.add('chat-item');
                newChat.onclick = function() {
                    cargarChat(usuario);
                };
                chatList.appendChild(newChat);
            }

            // Cargar la conversación del nuevo chat
            cargarChat(usuario);

            // Notificar al backend sobre el nuevo chat
            await fetch('/iniciar_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ usuario })
            });

            // Cerrar el modal
            document.getElementById('nuevoChatModal').style.display = "none";
        }

        // Función para cargar un chat
        function cargarChat(usuario) {
            currentChatUser = usuario;

            // Marcar el chat como activo
            document.querySelectorAll('.chat-list div').forEach(div => div.classList.remove('active'));
            document.getElementById('chat_' + usuario).classList.add('active');

            // Mostrar los mensajes del chat seleccionado
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = ''; // Limpiar mensajes anteriores

            chats[usuario].forEach(msg => {
                const newMessage = document.createElement('div');
                newMessage.innerHTML = `<strong>${msg.sender}:</strong><br>${msg.text}`;
                messageContainer.appendChild(newMessage);
            });
        }

        // Event listener para el botón de enviar mensaje
        document.getElementById('sendMessageButton').onclick = async function() {
            const message = document.getElementById('messageInput').value;
            if (message && currentChatUser) {
                await enviarMensaje(currentChatUser, message);
            }
        };

        // Función para enviar mensajes
        async function enviarMensaje(usuario, message) {
            if (!chats[usuario]) {
                chats[usuario] = [];
            }

            const msg = { sender: 'Yo', text: message };
            chats[usuario].push(msg);

            const messageContainer = document.getElementById('messageContainer');
            const newMessage = document.createElement('div');
            newMessage.innerHTML = `<strong>Yo:</strong><br>${message}`;
            messageContainer.appendChild(newMessage);

            document.getElementById('messageInput').value = ''; // Limpiar el input

            // Enviar mensaje al backend
            await fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ usuario, message })
            });
        }

        // Función para recibir mensajes
        function recibirMensaje(usuario, message) {
            if (!chats[usuario]) {
                chats[usuario] = [];
            }

            const msg = { sender: usuario, text: message };
            chats[usuario].push(msg);

            if (usuario === currentChatUser) {
                const messageContainer = document.getElementById('messageContainer');
                const newMessage = document.createElement('div');
                newMessage.innerHTML = `<strong>${usuario}:</strong><br>${message}`;
                messageContainer.appendChild(newMessage);
            }
        }

        // Manejar el evento de agregar contacto
        document.getElementById('agregarContactoButton').onclick = async function() {
            const contactJid = document.getElementById('contactJid').value;
            if (contactJid) {
                const response = await fetch('/add_contact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contact_jid: contactJid })
                });

                if (response.ok) {
                    alert('Contacto agregado correctamente');
                    // Podrías agregar el contacto a la lista de contactos en la interfaz
                } else {
                    alert('Error al agregar contacto');
                }

                // Cerrar el modal
                document.getElementById('agregarContactoModal').style.display = "none";
            }
        };

        // Manejar el evento de cerrar sesión
        document.getElementById('cerrarSesion').onclick = async function() {
            const response = await fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                window.location.href = "/";
            } else {
                alert("Error al cerrar sesión.");
            }
        };

        // WebSockets para manejar las actualizaciones en tiempo real
        socket.on('new_contact', function(data) {
            const contactJid = data.contact_jid;
            if (!document.getElementById('chat_' + contactJid)) {
                const chatList = document.getElementById('chatList');
                const newChat = document.createElement('div');
                newChat.textContent = contactJid;
                newChat.id = 'chat_' + contactJid;
                newChat.classList.add('chat-item');
                newChat.onclick = function() {
                    cargarChat(contactJid);
                };
                chatList.appendChild(newChat);
            }
        });

        socket.on('update_contacts', function(data) {
            const contacts = data.contacts;
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = ''; // Limpiar la lista actual

            contacts.forEach(contactJid => {
                if (!document.getElementById('chat_' + contactJid)) {
                    const newChat = document.createElement('div');
                    newChat.textContent = contactJid;
                    newChat.id = 'chat_' + contactJid;
                    newChat.classList.add('chat-item');
                    newChat.onclick = function() {
                        cargarChat(contactJid);
                    };
                    chatList.appendChild(newChat);
                }
            });
        });

    </script>
</body>
</html>
